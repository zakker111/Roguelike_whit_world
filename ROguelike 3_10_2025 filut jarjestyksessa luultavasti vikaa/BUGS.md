# BUGS

- npc are not going in inns bed or upstairs of inn (investigate stairs congestion, upstairs routing, bed‑adjacent tile availability)
- some times in towns some extra signs and fire places inside walls
- some npc dont sleep in theid beds
- some work needed for smoketestrunner
- multirun in smoketest skips first multirun 
- creatures don't spawn reliably in Region Map (wildlife) — verify GameData.animals loaded, spawn gating/probabilities, and per‑tile cleared state
- creatures spawn sometetimes too often atleast in fotest and same place when entering regional map they dont move but they do flee 
- [FIXED] Followers in Region Map and ruins would sometimes multiply or spawn far from the player:
  - In some ruins runs, spawnInDungeon was invoked twice (once on entering Region Map and once during RUINS encounter setup), which created duplicate runtime allies for the same follower.
  - In encounters and Region Map, follower spawn logic could fall back to arbitrarily distant tiles when no nearby spot was found, leading to allies appearing at remote corners of the map.
  - Now:
    - RegionMapRuntime only calls FollowersRuntime.spawnInDungeon once per Region Map entry; the ruins-specific encounter no longer re-spawns followers.
    - FollowersRuntime.spawnInDungeon tracks existing follower actors via _followerId and will not create a second runtime ally for the same follower on the current map.
    - findSpawnTileNearPlayer uses a larger local radius for encounters/Region Map and refuses to fall back to distant tiles; when no nearby spot is free, followers simply do not spawn and a log line explains that they cannot find room nearby.
- [FIXED] in dungeons when enemies fight each other they are logged (which is good for debugging purposes), but they gave player XP when they killed each other
- in dungeons enemies seems to show behind walls(not line of sight)
- in encounters ui says in left counter all creatures something it should not say anything in ruins or encounters
- VERIFY this happens Dungeon markers color-coded by level on main map and minimap: green (1–2), amber (3), red (4–5). 
- there is something wierd when creature spawns same map in region_map and so one some blood stanes are followed by next region map from ruins or animals(creatures) creatures dont move in map when spawning them
- minimap shows all chunks when going in ruins, dungeons, towns etc and re entering
- minimap shows dungeons and towns
- dungeons sometimes carry over some wierd stuff like camp fires and some other shit from encounters 
- caravan master does not seem to spawn in towns cities etc. when caravan enters it
- caravans in towns need verification: prefab caravan stalls/shops vs actual parked caravans and town presence behavior
- dungeon mountain passes (dungeons biased to spawn near mountain edges) don’t seem to spawn in practice; investigate terrain bias and anchor selection in world/infinite_gen.js and world/world.js
- mountain-pass dungeons (A/B linked pair) are currently unreliable: interior portal + normal exit behavior does not consistently send the player to the intended far-side overworld tile; treat mountain-pass dungeon travel as broken for now
- world generation / infinite overworld gets slow and sluggish after exploring large chunks of the world; investigate performance of infinite_gen + world_runtime expansion and caching when many chunks have been visited
- sometimes the player can trade with a shopkeeper even when they are not at their shop (e.g., bumping them away from the shop door still opens the shop UI)
- in some towns, ground/terrain tinting still changes incorrectly or inconsistently (tiles changing biome color unexpectedly)
- animals/creatures on the Region Map sometimes use odd or incorrect glyphs (verify animal glyph mapping in region map overlays)
- Quest Board bandit encounter (“Bandits near the farm”) does not always spawn followers correctly:
  - When starting the quest encounter from the `E` marker, followers often log “Your followers cannot find room to stand nearby in this area.” even on relatively open snow/snow-forest tiles.
  - This suggests a mismatch between the camp-style encounter map, region/encounter walkability, and follower spawn radius/occupancy checks for that specific template.
  - Investigate FollowersRuntime.findSpawnTileNearPlayer and quest_service → EncounterRuntime.enter wiring for the `bandits_farm` quest template to ensure at least one nearby spawn tile is found when the player has space to move in multiple directions.
- Followers sometimes fail to spawn in random encounters even when the area around the player looks open (especially in snow biomes):
  - The log “Your followers cannot find room to stand nearby in this area.” appears repeatedly on encounter entry, but the player can still move several tiles in multiple directions.
  - Root cause unknown; likely interaction between encounter map generators (camp/ambush/ruins), ctx.isWalkable tiles, and occupancy checks in FollowersRuntime.findSpawnTileNearPlayer.
  - Needs focused repro cases and visual inspection (FOV on, GOD/enemy markers) to see what is actually blocking follower tiles in those encounters.
- Possible follower state bug after sleeping in town inns:
  - After travelling to town with active followers, sleeping at the inn, and then returning to the dungeon/encounter, followers sometimes do not follow the player into the dungeon at all.
  - In some runs, followers later appear only in scripted encounters (e.g., overworld events) and can spawn far away from the player instead of near the player’s position.
  - Likely related to FollowersRuntime.spawnInDungeon/spawnInTown and syncFollowersFromTown/syncFollowersFromDungeon not fully updating follower runtime state across town sleep/rest flows; needs a focused repro path and inspection of follower record vs runtime actors when using inns.
- [FIXED] Seppo's True Blade (and other two-handed hand weapons that occupy both hands) previously counted Attack twice for followers when the same item was equipped in left and right; Attack/Defense aggregation for both players and followers now counts each equipped item only once so two-handed weapons behave as a single blade instead of double-stacking damage
- In one dungeon run, Seppo spawned as a wild NPC inside a dungeon room but did not move or respond to interaction:
  - Seppo appeared in a dungeon context (not town), was stationary, and bumping into him did not open any dialog or shop UI.
  - Needs investigation of how Seppo (or Seppo-like caravan blacksmith NPCs) can leak into dungeon spawns and why their interaction handler is not active there.
  - Likely related to shared prefab usage or NPC archetype reuse between town/castle and dungeon maps without proper mode-specific behavior.
- World map sometimes shows leftover road tiles in unexpected places:
  - After some world generations, there are isolated or partial road segments that do not connect to towns, castles, or obvious points of interest.
  - These road remnants look like artifacts from previous road generation passes or abandoned routes and can appear in the middle of wilderness.
  - Investigate overworld path/road generation and cleanup code to ensure roads are only kept when they connect meaningful locations and that unused draft paths are removed.