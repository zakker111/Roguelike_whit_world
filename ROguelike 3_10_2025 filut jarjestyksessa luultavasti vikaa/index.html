<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tiny Roguelike</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Anchor all relative URLs to site root to avoid 404s when preview opens /index.html/index.html -->
  <base href="/" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/ui/style.css">
  <link rel="icon" href="https://fav.farm/%F0%9F%8E%B2">
</head>
<body>
  <script>
    (function() {
      try {
        var p = String(location.pathname || '');
        if (p.indexOf('/index.html/index.html') !== -1) {
          var url = new URL(location.href);
          url.pathname = '/index.html';
          location.replace(url.toString());
        }
      } catch (_) {}
    })();
  </script>
  <div class="ui">
    <div class="title">Tiny Roguelike</div>
    <div class="stats">
      <span id="health">HP: 40</span>
      <span id="floor">Floor: 1</span>
      <button id="wait-btn" class="btn" title="Spend one turn doing nothing" style="margin-left:10px; padding:4px 8px; font-size:12px;">Wait</button>
      <button id="god-open-btn" class="btn" title="Open GOD panel (keyboard: P)" style="margin-left:6px; padding:4px 8px; font-size:12px;">GOD</button>
      <button id="help-open-btn" class="btn" title="Open Help panel (keyboard: F1)" style="margin-left:6px; padding:4px 8px; font-size:12px;">Help</button>
    </div>
  </div>

  <canvas id="game" width="960" height="640"></canvas>
  <div class="log" id="log"></div>
  <!-- Optional right-side live log mirror -->
  <div class="log side" id="log-right"></div>
  <script>
    // Apply mirror preference to the side log's visibility
    (function () {
      try {
        var el = document.getElementById("log-right");
        if (el && window.LOG_MIRROR === false) {
          el.style.display = "none";
        }
      } catch (_) {}
    })();
  </script>

  <div id="loot-panel" class="loot-panel" hidden>
    <div class="loot-title">Loot acquired</div>
    <ul id="loot-list"></ul>
    <div class="loot-hint">Press any key or click to close</div>
  </div>

  <div id="gameover-panel" class="gameover-panel" hidden>
    <div class="loot-title">Game Over</div>
    <div id="gameover-summary" class="gameover-summary"></div>
    <button id="restart-btn" class="btn">Restart</button>
    <div class="loot-hint">Press R to restart</div>
  </div>

  <div id="inv-panel" class="inv-panel" hidden>
    <div class="inv-title">Inventory & Equipment</div>
    <div id="inv-stats" class="inv-stats"></div>
    <div id="equip-slots" class="equip-grid"></div>
    <div class="inv-subtitle">Inventory</div>
    <ul id="inv-list" class="inv-list"></ul>
    <div class="loot-hint">Click an equippable item to equip. Press I or Esc to close.</div>
  </div>

  <div id="god-panel" class="inv-panel" hidden>
    <div class="inv-title">GOD Mode</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
      <button id="god-heal-btn" class="btn">Fully Heal</button>
      <button id="god-spawn-btn" class="btn">Spawn Random Items</button>
      <button id="god-spawn-enemy-btn" class="btn">Spawn Enemy Nearby</button>
      <button id="god-spawn-stairs-btn" class="btn">Spawn Stairs Here</button>
    </div>
    <div class="inv-subtitle">Field of view (FOV)</div>
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
      <input id="god-fov" type="range" min="3" max="14" step="1" />
      <span id="god-fov-value" class="help" style="font-size:12px;"></span>
    </div>

    <div class="inv-subtitle">Encounters</div>
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
      <input id="god-enc-rate" type="range" min="0" max="100" step="1" />
      <span id="god-enc-rate-value" class="help" style="font-size:12px;"></span>
    </div>

    <div class="inv-subtitle">Logs</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
      <button id="god-toggle-mirror-btn" class="btn">Side Log: On</button>
    </div>
    <div class="inv-subtitle">Combat</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
      <button id="god-toggle-crit-btn" class="btn">Always Crit: Off</button>
    </div>
    <div class="inv-subtitle">Render</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
      <button id="god-toggle-grid-btn" class="btn">Grid: On</button>
      <button id="god-toggle-town-overlay-btn" class="btn" title="Show occupied houses and NPC targets in town">Overlay: Off</button>
      <button id="god-toggle-town-paths-btn" class="btn" title="Draw NPC planned paths (town only)">Paths: Off</button>
      <button id="god-toggle-home-paths-btn" class="btn" title="Draw full home paths in blue (NPCs to their homes/beds)">Home Paths: Off</button>
      <button id="god-toggle-route-paths-btn" class="btn" title="Draw blue line to current destination for each NPC">Routes: Off</button>
      <button id="god-toggle-perf-btn" class="btn" title="Show turn/draw perf timings in HUD top bar">Perf: On</button>
      <button id="god-toggle-minimap-btn" class="btn" title="Show or hide the overworld minimap">Minimap: On</button>
      <button id="god-check-home-btn" class="btn" title="Compute each NPCâ€™s full route home and report unreachable cases">Check Home Routes</button>
      <button id="god-check-inn-tavern-btn" class="btn" title="Report coordinates for Inn and Plaza/Square">Check Inn/Plaza</button>
      <button id="god-diagnostics-btn" class="btn" title="Show system diagnostics (determinism source, seed, module handles) in log">Diagnostics</button>
      <button id="god-newgame-btn" class="btn" title="Start a new game immediately">Start New Game</button>
      <div style="display:flex; gap:6px; align-items:center;">
        <button id="god-run-smoke-btn" class="btn" title="Configure and run automated smoke tests">Run Smoke Test</button>
        <label for="god-smoke-count" class="help" style="font-size:12px; color:#8a98b0;">Runs:</label>
        <input id="god-smoke-count" type="number" min="1" max="20" step="1" value="1" style="width:64px; padding:4px 6px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;" />
      </div>
    </div>
    <div id="god-check-output" class="help" style="font-size:12px; color:#cbd5e1; margin:6px 0 12px 0;"></div>

    <div class="inv-subtitle">Analysis</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
      <button id="god-run-analysis-btn" class="btn" title="Generate size & duplication report (client-side)">Run Analysis</button>
      <button id="god-download-analysis-btn" class="btn" title="Download last analysis report (Markdown)">Download Report</button>
    </div>
    <div id="god-analysis-output" class="help" style="font-size:12px; color:#cbd5e1; margin:6px 0 12px 0;"></div>

    <div class="inv-subtitle">RNG</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
      <input id="god-seed-input" type="number" min="0" step="1" placeholder="Enter seed (uint32)" style="width:190px; padding:6px 8px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;" />
      <button id="god-apply-seed-btn" class="btn">Apply Seed</button>
      <button id="god-reroll-seed-btn" class="btn">Reroll</button>
      <span id="god-seed-help" class="help" style="font-size:12px; color:#8a98b0;"></span>
    </div>
    <div class="loot-hint">Press Esc to close</div>
  </div>

  <!-- Smoke Test Configuration Panel -->
  <div id="smoke-panel" class="inv-panel" hidden>
    <div class="inv-title">Smoke Test Configuration</div>
    <div class="help" style="font-size:12px; color:#8a98b0; margin-bottom:8px;">
      Select scenarios to run and the number of iterations. Press Run to start.
    </div>
    <div class="inv-subtitle">Scenarios</div>
    <div id="smoke-scenarios" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:6px; margin-bottom:12px;">
      <!-- checkboxes inserted by UI.renderSmokeOptions() -->
    </div>
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
      <label for="smoke-count" class="help" style="font-size:12px; color:#8a98b0;">Runs:</label>
      <input id="smoke-count" type="number" min="1" max="20" step="1" value="1" style="width:80px; padding:6px 8px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;" />
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
      <button id="smoke-run-btn" class="btn">Run</button>
      <button id="smoke-run-linear-btn" class="btn" title="Run all scenarios in a fixed linear order">Run Linear All</button>
      <button id="smoke-cancel-btn" class="btn">Cancel</button>
    </div>
    <div class="loot-hint">Press Esc to close</div>
  </div>

  <!-- Boot flags and persisted preferences -->
  <script>
    (function () {
      try {
        const params = new URLSearchParams(location.search);
        // DEV flag
        if (params.get("dev") === "1") { window.DEV = true; localStorage.setItem("DEV", "1"); }
        if (params.get("dev") === "0") { window.DEV = false; localStorage.removeItem("DEV"); }
        if (localStorage.getItem("DEV") === "1") window.DEV = true;

        // Log mirror toggle (?mirror=1 or ?mirror=0), persisted
        if (params.get("mirror") === "1") { window.LOG_MIRROR = true; localStorage.setItem("LOG_MIRROR", "1"); }
        if (params.get("mirror") === "0") { window.LOG_MIRROR = false; localStorage.setItem("LOG_MIRROR", "0"); }
        if (typeof window.LOG_MIRROR === "undefined") {
          const m = localStorage.getItem("LOG_MIRROR");
          if (m === "1") window.LOG_MIRROR = true;
          else if (m === "0") window.LOG_MIRROR = false;
          // default: enabled unless user turned it off
        }
      } catch (_) {}
    })();
  </script>

  <!-- Core context and deterministic RNG service -->
  <script src="/core/ctx.js" type="module" defer></script>
  <script src="/core/rng_service.js" type="module" defer></script>

  <!-- Utilities (available early for modules that use shared helpers/RNG fallback) -->
  <script src="/utils/utils.js" type="module" defer></script>
  <script src="/utils/rng_fallback.js" type="module" defer></script>

  <!-- Boot diagnostics: log RNG source and seed -->
  <script>
    (function () {
      try {
        var src = (typeof window !== "undefined" && window.RNG && typeof window.RNG.rng === "function") ? "RNG.service" : "mulberry32.fallback";
        var seed = "(random)";
        if (typeof window !== "undefined" && window.RNG && typeof window.RNG.getSeed === "function") {
          var s = window.RNG.getSeed();
          if (s != null) seed = String((Number(s) >>> 0));
        } else {
          try {
            var sRaw = localStorage.getItem("SEED");
            if (sRaw != null) seed = String((Number(sRaw) >>> 0));
          } catch (_) {}
        }
        if (typeof window !== "undefined" && window.Logger && typeof window.Logger.log === "function") {
          window.Logger.log("Boot: RNG=" + src + "  Seed=" + seed, "notice");
        } else if (typeof window !== "undefined" && window.DEV) {
          console.debug("[BOOT] RNG=" + src + "  Seed=" + seed);
        }
      } catch (_) {}
    })();
  </script>

  <!-- World modules -->
  <script src="/world/world.js" type="module" defer></script>
  <script src="/world/los.js" type="module" defer></script>
  <script src="/world/fov.js" type="module" defer></script>

  <!-- Data (load registries before adapters so they're ready sooner) -->
  <script src="/data/loader.js" type="module" defer></script>
  <script src="/data/flavor.js" type="module" defer></script>
  <script src="/data/god.js" type="module" defer></script>

  <!-- Entities and dungeon adapters -->
  <script src="/entities/items.js" type="module" defer></script>
  <script src="/entities/enemies.js" type="module" defer></script>
  <script src="/dungeon/dungeon_items.js" type="module" defer></script>
  <script src="/entities/loot.js" type="module" defer></script>

  <!-- Dungeon core and helpers -->
  <script src="/dungeon/occupancy_grid.js" type="module" defer></script>
  <script src="/dungeon/dungeon_state.js" type="module" defer></script>
  <script src="/dungeon/dungeon.js" type="module" defer></script>

  <!-- Services -->
  <script src="/services/time_service.js" type="module" defer></script>
  <script src="/services/shop_service.js" type="module" defer></script>
  <script src="/services/props_service.js" type="module" defer></script>
  <script src="/services/encounter_service.js" type="module" defer></script>

  <!-- Combat modules -->
  <script src="/combat/combat_utils.js" type="module" defer></script>
  <script src="/combat/combat.js" type="module" defer></script>
  <script src="/combat/stats.js" type="module" defer></script>
  <script src="/combat/status_effects.js" type="module" defer></script>
  <script src="/combat/equipment_decay.js" type="module" defer></script>

  <!-- UI and rendering -->
  <script src="/ui/logger.js" type="module" defer></script>
  <script>
    // Initialize Logger once DOM is ready; deferred scripts will have loaded by then
    document.addEventListener('DOMContentLoaded', function () {
      try {
        if (typeof window !== "undefined" && window.Logger && typeof window.Logger.init === 'function') {
          window.Logger.init(undefined, 80);
        }
      } catch (e) {}
    });
  </script>
  <script src="/ui/tileset.js" type="module" defer></script>
  <!-- Render split modules (loaded before orchestrator) -->
  <script src="/ui/render_core.js" type="module" defer></script>
  <script src="/ui/render_overworld.js" type="module" defer></script>
  <script src="/ui/render_town.js" type="module" defer></script>
  <script src="/ui/render_dungeon.js" type="module" defer></script>
  <script src="/ui/render_overlays.js" type="module" defer></script>
  <!-- Orchestrator -->
  <script src="/ui/render.js" type="module" defer></script>
  <script src="/ui/decals.js" type="module" defer></script>
  <script src="/ui/ui.js" type="module" defer></script>
  <!-- ShopUI module -->
  <script src="/ui/shop_panel.js" type="module" defer></script>
  <!-- Quest Board UI module -->
  <script src="/ui/quest_board.js" type="module" defer></script>
  <!-- Step 6: InputMouse (canvas clicks) loaded before core/game.js -->
  <script src="/ui/input_mouse.js" type="module" defer></script>

  <!-- Player and equipment -->
  <script src="/entities/player_utils.js" type="module" defer></script>
  <script src="/entities/player_equip.js" type="module" defer></script>
  <script src="/entities/player.js" type="module" defer></script>

  <!-- AI -->
  <script src="/ai/ai.js" type="module" defer></script>
  <script src="/ai/town_ai.js" type="module" defer></script>

  <!-- Worldgen -->
  <script src="/worldgen/town_gen.js" type="module" defer></script>

  <!-- Core runtime -->
  <script src="/core/actions.js" type="module" defer></script>
  <script src="/core/town_state.js" type="module" defer></script>
  <script src="/core/modes.js" type="module" defer></script>
  <script src="/core/game_loop.js" type="module" defer></script>
  <script src="/core/input.js" type="module" defer></script>
  <script src="/core/game_api.js" type="module" defer></script>
  <!-- Phase 2 modules -->
  <script src="/core/fov_camera.js" type="module" defer></script>
  <script src="/core/inventory_controller.js" type="module" defer></script>
  <script src="/core/town_runtime.js" type="module" defer></script>
  <script src="/core/dungeon_runtime.js" type="module" defer></script>
  <script src="/core/encounter_runtime.js" type="module" defer></script>
  <script src="/core/ui_bridge.js" type="module" defer></script>
  <!-- Region Map overlay runtime -->
  <script src="/region_map/region_map_runtime.js" type="module" defer></script>
  <script src="/core/game.js" type="module" defer></script>

  <!-- Optional smoke test runner: load when ?smoketest=1 -->
  <script>
    (function () {
      try {
        var params = new URLSearchParams(location.search);
        if (params.get("smoketest") === "1") {
          console.log("[SMOKE] loader: detected ?smoketest=1, injecting runner");
          var legacy = params.get("legacy") === "1";
          var injectList = [
            // Helpers
            "/smoketest/helpers/dom.js",
            "/smoketest/helpers/budget.js",
            "/smoketest/helpers/logging.js",
            "/smoketest/helpers/movement.js",
            "/smoketest/helpers/teleport.js",
            // Capabilities
            "/smoketest/capabilities/detect.js",
            "/smoketest/capabilities/rng_audit.js",
            // Reporting
            "/smoketest/reporting/render.js",
            "/smoketest/reporting/export.js",
            // Runner helpers
            "/smoketest/runner/init.js",
            "/smoketest/runner/banner.js",
            // Scenarios (load all before orchestrator to ensure availability)
            "/smoketest/scenarios/dungeon.js",
            "/smoketest/scenarios/town.js",
            "/smoketest/scenarios/inventory.js",
            "/smoketest/scenarios/combat.js",
            "/smoketest/scenarios/overlays.js",
            "/smoketest/scenarios/world.js",
            "/smoketest/scenarios/determinism.js",
            "/smoketest/scenarios/town_flows.js",
            "/smoketest/scenarios/dungeon_persistence.js",
            "/smoketest/scenarios/town_diagnostics.js",
            "/smoketest/scenarios/api.js",
            "/smoketest/scenarios/encounters.js",
            // Orchestrator (default) - load last so scenarios are ready
            "/smoketest/runner/runner.js"
            // Legacy thin shim appended below
          ];
          if (legacy) {
            injectList.push("/smoketest/smoketest_runner.js");
          }
          var injectSeq = function (list) {
            var i = 0;
            function next() {
              if (i >= list.length) return;
              try {
                var s = document.createElement("script");
                s.src = list[i++];
                s.onload = next;
                s.onerror = function (e) { console.error("[SMOKE] loader: failed to load", s.src, e); next(); };
                // Use async=false by not setting async; dynamic scripts execute on load
                document.body.appendChild(s);
              } catch (e) {
                console.error("[SMOKE] loader: injection error", e);
                next();
              }
            }
            next();
          };
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", function () { injectSeq(injectList); });
          } else {
            injectSeq(injectList);
          }
          window.SMOKETEST_REQUESTED = true;
        } else {
          console.log("[SMOKE] loader: no smoketest param");
        }
      } catch (e) {
        console.error("[SMOKE] loader: error", e);
      }
    })();
  </script>
</body>
</html>