<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tiny Roguelike</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Anchor all relative URLs to site root to avoid 404s when preview opens /index.html/index.html -->
  <base href="/" />
  <!-- Strict Content Security Policy to prevent third-party analytics/scripts from loading -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' data: blob:;
    img-src 'self' data: https://fav.farm;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    script-src 'self' 'unsafe-inline' https://cosine.sh;
    connect-src 'self';
  ">
  <!-- App version for storage invalidation on deploy -->
  <meta name="app-version" content="1.50.1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/ui/style.css">
  <link rel="icon" href="https://fav.farm/%F0%9F%8E%B2">
</head>
<body>
  <script>
    (function() {
      try {
        var p = String(location.pathname || '');
        if (p.indexOf('/index.html/index.html') !== -1) {
          var url = new URL(location.href);
          url.pathname = '/index.html';
          location.replace(url.toString());
        }
      } catch (_) {}
    })();
  </script>
  <!-- Clear persisted game state automatically when the deployed version changes.
       This guarantees a clean state after deploys without affecting same-version reloads. -->
  <script>
    (function() {
      try {
        var meta = document.querySelector('meta[name="app-version"]');
        var ver = meta ? String(meta.getAttribute('content') || '') : '';
        var KEY = 'APP_VERSION';
        var prev = null;
        try { prev = localStorage.getItem(KEY); } catch(_) {}
        if (!prev || prev !== ver) {
          // Mark a flag that disables LS writes during this first load if desired
          // and clear any persisted run state from previous versions.
          try {
            // Use same keys Town/Dungeon/Region use; matches data/god.js clearGameStorage
            localStorage.removeItem('DUNGEON_STATES_V1');
            localStorage.removeItem('TOWN_STATES_V1');
            localStorage.removeItem('REGION_CUTS_V1');
            localStorage.removeItem('REGION_ANIMALS_V1');
            localStorage.removeItem('REGION_ANIMALS_V2');
            localStorage.removeItem('REGION_STATE_V1');
            localStorage.removeItem('GM_STATE_V1');
          } catch (_) {}
          // Also reset in-memory mirrors if a previous tab/session left them behind
          try {
            window._DUNGEON_STATES_MEM = Object.create(null);
            window._TOWN_STATES_MEM = Object.create(null);
          } catch (_) {}
          try { localStorage.setItem(KEY, ver || 'dev'); } catch(_) {}
          try { console.log('[BOOT] Cleared persisted game state due to version change ->', ver); } catch(_) {}
        }
      } catch (_) {}
    })();
  </script>
  <div class="ui">
    <div class="title">Tiny Roguelike</div>
    <div class="stats">
      <span id="health">HP: 40</span>
      <span id="floor">Floor: 1</span>
      <button id="wait-btn" class="btn" title="Spend one turn doing nothing" style="margin-left:10px; padding:4px 8px; font-size:12px;">Wait</button>
      <button id="god-open-btn" class="btn" title="Open GOD panel (keyboard: P)" style="margin-left:6px; padding:4px 8px; font-size:12px;">GOD</button>
      <button id="help-open-btn" class="btn" title="Open Help panel (keyboard: F1)" style="margin-left:6px; padding:4px 8px; font-size:12px;">Help</button>
      <a href="/docs/" class="btn" title="Open Docs viewer (palette schema and more)" style="margin-left:6px; padding:4px 8px; font-size:12px;">Docs</a>
    </div>
  </div>

  <canvas id="game" width="960" height="640"></canvas>
  <div class="log" id="log"></div>
  <!-- Optional right-side live log mirror -->
  <div class="log side" id="log-right"></div>
  <script>
    // Apply mirror preference to the side log's visibility
    (function () {
      try {
        var el = document.getElementById("log-right");
        if (el && window.LOG_MIRROR === false) {
          el.style.display = "none";
        }
      } catch (_) {}
    })();
  </script>

  <div id="loot-panel" class="loot-panel" hidden>
    <div class="loot-title">Loot acquired</div>
    <ul id="loot-list"></ul>
    <div class="loot-hint">Press any key or click to close</div>
  </div>

  <div id="gameover-panel" class="gameover-panel" hidden>
    <div class="loot-title">Game Over</div>
    <div id="gameover-summary" class="gameover-summary"></div>
    <button id="restart-btn" class="btn">Restart</button>
    <div class="loot-hint">Press R to restart</div>
  </div>

  <div id="inv-panel" class="inv-panel" hidden>
    <div class="inv-title">Inventory &amp; Equipment</div>
    <div id="inv-stats" class="inv-stats"></div>
    <div id="equip-slots" class="equip-grid"></div>
    <div class="inv-subtitle">Inventory</div>
    <ul id="inv-list" class="inv-list"></ul>
    <div class="loot-hint">Click an equippable item to equip. Press I or Esc to close.</div>
  </div>

  <div id="god-panel" class="inv-panel" hidden>
    <div class="inv-title">GOD Mode</div>

    <!-- Quick Actions -->
    <div class="god-section god-row">
      <button id="god-heal-btn" class="btn">Fully Heal</button>
      <button id="god-toggle-invincible-btn" class="btn" title="Player cannot die; damage heals back immediately">Invincible: Off</button>
      <button id="god-spawn-btn" class="btn">Spawn Random Items</button>
      <button id="god-spawn-enemy-btn" class="btn">Spawn Enemy Nearby</button>
      <button id="god-spawn-stairs-btn" class="btn">Spawn Stairs Here</button>
      <button id="god-hire-follower-btn" class="btn" title="Hire a follower from followers.json (ignores normal acquisition flow)">Hire Follower (GOD)</button>
      <button id="god-enter-sandbox-btn" class="btn" title="Enter a small sandbox dungeon room (no save persistence)">Enter Sandbox (Dungeon Room)</button>
      <button id="god-newgame-btn" class="btn" title="Start New Game">Start New Game</button>
    </div>

    <!-- World & Encounters -->
    <div class="god-section">
      <div class="inv-subtitle">Field of View &amp; Encounters</div>
      <div class="god-row" style="margin-bottom:6px;">
        <label class="help" style="font-size:12px; color:#8a98b0;">FOV:</label>
        <input id="god-fov" type="range" min="3" max="14" step="1" />
        <span id="god-fov-value" class="help" style="font-size:12px;"></span>
      </div>

      <div class="god-row" style="margin-bottom:6px;">
        <label class="help" style="font-size:12px; color:#8a98b0;">Encounter rate:</label>
        <input id="god-enc-rate" type="range" min="0" max="100" step="1" />
        <span id="god-enc-rate-value" class="help" style="font-size:12px;"></span>
      </div>

      <div class="god-row" style="margin-bottom:8px;">
        <label class="help" style="font-size:12px; color:#8a98b0;">Template:</label>
        <select id="god-enc-select" style="min-width:220px; padding:6px 8px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;">
          <option value="">(auto)</option>
        </select>
        <button id="god-enc-start-btn" class="btn" title="Start selected encounter immediately (world mode)">Start Now</button>
        <button id="god-enc-arm-btn" class="btn" title="Trigger selected encounter on next world move">Arm Next Move</button>
        <button id="god-town-bandits-btn" class="btn" title="Spawn a guards vs bandits battle using the Guards vs Bandits encounter template (world mode)">Bandits at Gate</button>
      </div>

      
    </div>

    <!-- Render & HUD -->
    <div class="god-section">
      <div class="inv-subtitle">Render Overlays</div>
      <div class="god-row" style="margin-bottom:6px;">
        <button id="god-toggle-grid-btn" class="btn">Grid: On</button>
        <button id="god-toggle-town-overlay-btn" class="btn" title="Show occupied houses and NPC targets in town">Overlay: Off</button>
        <button id="god-toggle-town-paths-btn" class="btn" title="Draw NPC planned paths (town only)">Paths: Off</button>
        <button id="god-toggle-home-paths-btn" class="btn" title="Draw full home paths in blue (NPCs to their homes/beds)">Home Paths: Off</button>
        <button id="god-toggle-route-paths-btn" class="btn" title="Draw blue line to current destination for each NPC">Routes: Off</button>
        <button id="god-toggle-minimap-btn" class="btn" title="Show or hide the overworld minimap">Minimap: On</button>
      </div>

      <div class="inv-subtitle">HUD &amp; Perf</div>
      <div class="god-row" style="margin-bottom:8px;">
        <button id="god-toggle-ow-hud-btn" class="btn" title="Show or hide the Overworld HUD (biome + clock)">Overworld HUD: On</button>
        <button id="god-toggle-region-hud-btn" class="btn" title="Show or hide the Region Map HUD (title + clock + animals)">Region HUD: On</button>
        <button id="god-toggle-enc-hud-btn" class="btn" title="Show or hide the Encounter HUD (biome + clock)">Encounter HUD: On</button>
        <button id="god-toggle-perf-btn" class="btn" title="Show turn/draw perf timings in HUD">Perf: On</button>
        <label class="help" style="font-size:12px; color:#8a98b0;">Teleport:</label>
        <select id="god-teleport-target" style="min-width:130px; padding:6px 8px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;">
          <option value="tower">Nearest Tower</option>
          <option value="town">Nearest Town/Castle</option>
          <option value="harbor">Nearest Harbor Town</option>
          <option value="dungeon">Nearest Dungeon</option>
          <option value="mountain_dungeon">Nearest Mountain Dungeon</option>
          <option value="ruins">Nearest Ruins</option>
          <option value="castle">Nearest Castle</option>
        </select>
        <button id="god-teleport-btn" class="btn" title="Teleport to the selected overworld destination (world mode only)">Teleport</button>
      </div>
    </div>

    <!-- Town Debug -->
    <div class="god-section">
      <div class="inv-subtitle">Town Debug</div>
      <div class="god-row" style="margin-bottom:6px;">
        <button id="god-check-home-btn" class="btn" title="Compute each NPCâ€™s full route home and report unreachable cases">Check Home Routes</button>
        <button id="god-check-inn-tavern-btn" class="btn" title="Report coordinates for Inn and Plaza/Square">Check Inn/Plaza</button>
        <button id="god-check-signs-btn" class="btn" title="List shop signage and prefab sign intent (outside/inside)">Check Signs</button>
        <button id="god-check-prefabs-btn" class="btn" title="List loaded prefabs and which ones were used in this town">Check Prefabs</button>
      </div>
      <div class="god-row" style="margin-bottom:6px;">
        <button id="god-diagnostics-btn" class="btn" title="Show system diagnostics (determinism source, seed, module handles) in log">Diagnostics</button>
        <button id="god-run-validation-btn" class="btn" title="Run data validation and show counts">Run Validation</button>
        <button id="god-download-validation-btn" class="btn" title="Download latest validation report as JSON">Download Validation</button>
      </div>
      <div id="god-check-output" class="help" style="font-size:12px; color:#cbd5e1; margin:4px 0 8px 0;"></div>
    </div>

    <!-- Combat & Status -->
    <div class="god-section">
      <div class="inv-subtitle">Combat</div>
      <div class="god-row" style="margin-bottom:6px;">
        <button id="god-toggle-crit-btn" class="btn">Always Crit: Off</button>
        <button id="god-apply-status-btn" class="btn" title="Apply a status effect to the next enemy you hit">Apply Status Effect</button>
      </div>

      <div class="inv-subtitle">Player Status Effects</div>
      <div class="god-row" style="margin-bottom:6px;">
        <button id="god-apply-bleed-btn" class="btn" title="Apply Bleed for 3 turns to the player">Apply Bleed (3)</button>
        <button id="god-apply-dazed-btn" class="btn" title="Apply Dazed for 2 turns to the player">Apply Dazed (2)</button>
        <button id="god-clear-effects-btn" class="btn" title="Clear Bleed/Dazed from player">Clear Effects</button>
      </div>
    </div>

    <!-- Logs & Tracing -->
    <div class="god-section">
      <div class="inv-subtitle">Logs &amp; Tracing</div>
      <div class="god-row" style="margin-bottom:6px;">
        <button id="god-toggle-mirror-btn" class="btn">Side Log: On</button>
        <button id="god-toggle-trace-move-btn" class="btn" title="Enable movement trace logs (DEV or local setting)">Trace Move: Off</button>
        <button id="god-toggle-trace-enc-btn" class="btn" title="Enable encounter trace logs (DEV or local setting)">Trace Enc: Off</button>
        <button id="god-toggle-trace-shop-btn" class="btn" title="Enable shop trace logs (DEV or local setting)">Trace Shop: Off</button>
      </div>
      <div class="god-row" style="margin-bottom:6px;">
        <label class="help" style="font-size:12px; color:#8a98b0;">Level:</label>
        <select id="god-log-level" style="min-width:140px; padding:6px 8px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;">
          <option value="info">(info)</option>
          <option value="notice">notice</option>
          <option value="warn">warn</option>
          <option value="error">error</option>
          <option value="fatal">fatal</option>
          <option value="all">all</option>
        </select>
        <button id="god-log-reset-btn" class="btn" title="Reset log filters to defaults">Reset Logs</button>
        <button id="god-log-clear-btn" class="btn" title="Clear on-screen and in-memory logs">Clear Logs</button>
        <button id="god-log-download-btn" class="btn" title="Download current session logs">Download Logs</button>
        <button id="god-log-download-json-btn" class="btn" title="Download logs as JSON">Download JSON</button>
      </div>
      <div class="help" style="font-size:12px; color:#8a98b0; margin-bottom:6px;">Categories:</div>
      <div id="god-log-categories" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:6px; margin-bottom:4px;">
        <!-- checkboxes inserted by GodPanel.renderLogCategories() -->
      </div>
    </div>

    

    <!-- RNG & Theme -->
    <div class="god-section">
      <div class="inv-subtitle">RNG &amp; Theme</div>
      <div class="god-row" style="margin-bottom:6px;">
        <input id="god-seed-input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Enter seed (numbers only)" style="width:190px; padding:6px 8px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;" />
        <button id="god-apply-seed-btn" class="btn">Apply Seed</button>
        <button id="god-reroll-seed-btn" class="btn">Reroll</button>
        <span id="god-seed-help" class="help" style="font-size:12px; color:#8a98b0;"></span>
      </div>
      <div class="god-row" style="margin-bottom:4px;">
        <label class="help" style="font-size:12px; color:#8a98b0;">Palette:</label>
        <select id="god-palette-select" style="min-width:160px; padding:6px 8px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;">
          <option value="default">(default)</option>
          <option value="alt">alt</option>
        </select>
        <button id="god-apply-palette-btn" class="btn" title="Load selected palette and redraw">Apply</button>
      </div>
    </div>

    <!-- Tools & Analysis -->
    <div class="god-section">
      <div class="inv-subtitle">Tools &amp; Analysis</div>
      <div class="god-row" style="margin-bottom:6px;">
        <button id="god-run-analysis-btn" class="btn" title="Generate size &amp; duplication report (client-side)">Run Analysis</button>
        <button id="god-download-analysis-btn" class="btn" title="Download last analysis report (Markdown)">Download Report</button>
        <button id="god-open-prefab-editor-btn" class="btn" title="Open Prefab Editor (DEV)">Prefab Editor</button>
      </div>
      <div id="god-analysis-output" class="help" style="font-size:12px; color:#cbd5e1; margin:4px 0 4px 0;"></div>
    </div>

    <!-- GM Emission Sim -->
    <div class="god-section">
      <div class="inv-subtitle">GM Emission Sim</div>
      <div class="god-row" style="margin-bottom:6px;">
        <button id="god-run-gm-emission-sim-btn" class="btn" title="Run deterministic GM emission simulation scenarios">Run GM Emission Sim</button>
        <button id="god-copy-gm-emission-sim-btn" class="btn" title="Copy the latest GM emission sim report JSON to clipboard">Copy JSON</button>
      </div>
      <textarea id="god-gm-emission-sim-output" readonly style="width:100%; min-height:180px; padding:6px 8px; background:#0b1120; color:#e5e7eb; border:1px solid #334155; border-radius:6px; font-family:'JetBrains Mono', monospace; font-size:11px;"></textarea>
    </div>

    <!-- Smoke Tests -->
    <div class="god-section">
      <div class="inv-subtitle">Smoke Tests</div>
      <div class="god-row" style="margin-bottom:4px;">
        <button id="god-run-smoke-btn" class="btn" title="Configure and run automated smoke tests">Run Smoke Test</button>
        <label for="god-smoke-count" class="help" style="font-size:12px; color:#8a98b0;">Runs:</label>
        <input id="god-smoke-count" type="number" min="1" max="20" step="1" value="1" style="width:64px; padding:4px 6px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;" />
      </div>
    </div>

    <div class="loot-hint">Press Esc to close</div>
  </div>

  <!-- Smoke Test Configuration Panel -->
  <div id="smoke-panel" class="inv-panel" hidden>
    <div class="inv-title">Smoke Test Configuration</div>
    <div class="help" style="font-size:12px; color:#8a98b0; margin-bottom:8px;">
      Select scenarios to run and the number of iterations. Press Run to start.
    </div>
    <div class="inv-subtitle">Scenarios</div>
    <div id="smoke-scenarios" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:6px; margin-bottom:12px;">
      <!-- checkboxes inserted by UI.renderSmokeOptions() -->
    </div>
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
      <label for="smoke-count" class="help" style="font-size:12px; color:#8a98b0;">Runs:</label>
      <input id="smoke-count" type="number" min="1" max="20" step="1" value="1" style="width:80px; padding:6px 8px; background:#0f0f12; color:#e5e7eb; border:1px solid #334155; border-radius:6px;" />
    </div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
      <button id="smoke-run-btn" class="btn">Run</button>
      <button id="smoke-run-linear-btn" class="btn" title="Run all scenarios in a fixed linear order">Run Linear All</button>
      <button id="smoke-cancel-btn" class="btn">Cancel</button>
    </div>
    <div class="loot-hint">Press Esc to close</div>
  </div>

  <!-- Boot flags and persisted preferences -->
  <script>
    (function () {
      try {
        const params = new URLSearchParams(location.search);
        // DEV flag
        if (params.get("dev") === "1") { window.DEV = true; localStorage.setItem("DEV", "1"); }
        if (params.get("dev") === "0") { window.DEV = false; localStorage.removeItem("DEV"); }
        if (localStorage.getItem("DEV") === "1") window.DEV = true;

        // Log mirror toggle (?mirror=1 or ?mirror=0), persisted
        if (params.get("mirror") === "1") { window.LOG_MIRROR = true; localStorage.setItem("LOG_MIRROR", "1"); }
        if (params.get("mirror") === "0") { window.LOG_MIRROR = false; localStorage.setItem("LOG_MIRROR", "0"); }
        if (typeof window.LOG_MIRROR === "undefined") {
          const m = localStorage.getItem("LOG_MIRROR");
          if (m === "1") window.LOG_MIRROR = true;
          else if (m === "0") window.LOG_MIRROR = false;
          // default: enabled unless user turned it off
        }
      } catch (_) {}
    })();
  </script>

  <!-- Single entry module: imports all game modules and boots -->
  <script type="module" src="/src/main.js"></script>
</body>
</html>